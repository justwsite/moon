<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8">
<link rel="icon" href="icon.webp">
<title>Фазы Луны в землях Фаэруна</title><style>
* {background: #111827; padding: 10px; border-radius: 10px; font-family: sans-serif;}
body, html {font-size: 25px; color: #ffffff; border-radius: 0;}
span, select, option, button, input {background: #1f2937; color: inherit; font-size: inherit;}
input {border: 0; background: 0; width: 4ch;}
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
-webkit-appearance: none;margin: 0;}
input[type=number]:focus {outline: none; box-shadow: none;}
div {white-space: pre;}
</style></head><body>

Введите Год &emsp;<span><input type="number" min="0" id="numInput"> DR</span><br><br>

День в Forgotten Realms &emsp;<button onclick="prevOption(1)">&#10216</button>
<select id="select1"></select>
<button onclick="nextOption(1)">&#10217</button><br><br>

День в Real Life &emsp;<button onclick="prevOption(2)">&#10216</button>
<select id="select2"></select>
<button onclick="nextOption(2)">&#10217</button>

<div id="info"></div>
<script>
  const btn = document.querySelectorAll("button")
  const input = document.getElementById('numInput');
  const selectfr = document.getElementById('select1');
  const selectrl = document.getElementById('select2');
  const div = document.getElementById('info');

  function phase(m) {
    var cycle = 43830;
    let formula = 2*Math.PI*(m+cycle/2)/cycle;
    let result = Math.round( ((1-Math.cos(formula))*50) *100)/100;
    return result;}
  function moon() {
    var minutes = [0, 10957.5, 21915, 32872.5, 43830];
    var title = ["&#x1F315; Полнолуние", "&#x1F317; Последняя Четверть", "&#x1F311; Новолуние", "&#x1F313; Первая Четверть"];
    var dop = ["&#x1F316; Убывающая Луна", "&#x1F318; Убывающий Месяц", "&#x1F312; Растущий Месяц", "&#x1F314; Растущая Луна"];
    var d = selectfr.selectedIndex+1;
    if(!input.value) {
      div.innerHTML = "Введите год по летоисчислению Долин.";
      return;
    }
    var y = ((parseInt(input.value) % 4) + 4) % 4;
    let dd = 1;
    if (y==0 && d<214) {dd = 0}
    d = (d+dd+365*y)*1440;
    while(d-1440>43830) {d=d-43830;}
    var start = d-1440;
    var end = d-1;
    var txt = "";
    for(let i=0; i<5; i++) {
      if(start <= minutes[i] && minutes[i] <= end) {
        if(minutes[i]<d-720) {
          var first = selectfr.selectedIndex-1;
          var second = selectfr.selectedIndex;
        } else {
          var first = selectfr.selectedIndex;
          var second = selectfr.selectedIndex+1;
        }
        let limit = selectfr.options.length-1;
        if(first<0) {first = limit;}
        if(second>limit) {second = 0;}
        let a = selectfr.options[first]?.value;
        let b = selectfr.options[second]?.value;
        txt = title[i%4] + '\n' + "В ночь с " + a + " по " + b;
        break;
      }
    }
    if(txt=="") {
      let round = 0;
      for(let i=0; i<4; i++) {round=round+phase(d + (i * 360));}
      round = (round/4).toFixed(2);
      for(let i=0; i<4; i++) {
        if(minutes[i] <= d && d <= minutes[i+1]) {
          txt = dop[i] + "(" + round + "%)";
          break;
        }
      }
    }
    div.innerHTML = txt;}

  selectfr.addEventListener('change', () => {
    const Index = selectfr.selectedIndex;
    selectrl.selectedIndex = Index;
    moon();});
  selectrl.addEventListener('change', () => {
    const Index = selectrl.selectedIndex;
    selectfr.selectedIndex = Index;
    moon();});

  function prevOption(id) {
      var id1 = 'select' + id;
      var id2 = 'select' + (3-id);
      var s1 = document.getElementById(id1);
      var s2 = document.getElementById(id2);
      var i = s1.selectedIndex;
      let limit = s1.options.length-1;
      if (i > 0) {i = i-1;}
      else {i = limit;
        input.value = parseInt(input.value)-1;}
      s1.selectedIndex = i;
      s2.selectedIndex = i;
      input.dispatchEvent(new Event('input'));
      }
    function nextOption(id) {
      var id1 = 'select' + id;
      var id2 = 'select' + (3-id);
      var s1 = document.getElementById(id1);
      var s2 = document.getElementById(id2);
      var i = s1.selectedIndex;
      let limit = s1.options.length-1;
      if (i < limit) {i = i+1;}
      else {i=0;
        input.value = parseInt(input.value)+1;}
      s1.selectedIndex = i;
      s2.selectedIndex = i;
      input.dispatchEvent(new Event('input'));}

  function fill(array, arr, select) {
    var index = selectfr.selectedIndex || 0;
    if(!input.value) {
      let o = "&emsp;".repeat(6);
      select.innerHTML = "<option value='0'>" + o + "</option>";
      return;
    }
    select.innerHTML = '';
    for (let i=0; i<array.length; i++) {
      let w = array[i][0];
      let v = arr[i][0];
      let q = array[i][1];
      for (let k=1; k<=q; k++) {
        var d = k;
        var option = document.createElement('option');
        let spaces = 3;
        if(q==1) {d = "";
          spaces = 7;}
        else if(d<10) {spaces = 5;}
        option.value = d + " " + v;
        option.textContent = d + "\xA0".repeat(spaces) + w;
        select.appendChild(option);}}
    if(index>=selectfr.options.length) {index=selectfr.options.length-1;}
    select.selectedIndex = index;}

  input.addEventListener('input', () => {
    if (input.value) {btn.forEach(b => b.style.display = "inline-block");} 
    else {btn.forEach(b => b.style.display = "none");}
    var y = parseInt(input.value) || 0;
    var FR0 = [["Хаммер (Разгар Зимы)", 30], 
              ["Макушка зимы (Праздник)", 1], 
              ["Альтуриак (Месяц Зимы)", 30], 
              ["Чес (Месяц Закатов)", 30], 
              ["Тарсах (Месяц Гроз)", 30], 
              ["День Зеленой травы (Праздник)", 1], 
              ["Миртул (Месяц Таяния)", 30], 
              ["Киторн (Время Цветов)", 30], 
              ["Флеймрул (Месяц Летнего Прилива)", 30], 
              ["Солнцеворот (Праздник)", 1], 
              ["Щитовый сход (Праздник)", 0], 
              ["Элесиас (Месяц Высокого Солнца)", 30], 
              ["Элейнт (Месяц Увядания)", 30], 
              ["Праздник урожая (Праздник)", 1], 
              ["Марпенот (Месяц Листопадов)", 30], 
              ["Уктар (Месяц Гниения)", 30], 
              ["Пир Луны (Праздник)", 1], 
              ["Найтол (Закат Года)", 30]];
    var FR = [["Хаммер", 30], 
              ["Макушка зимы", 1], 
              ["Алтуриак", 30], 
              ["Чес", 30], 
              ["Тарсак", 30], 
              ["Зеленотравье", 1], 
              ["Миртул", 30], 
              ["Киторн", 30], 
              ["Флеймрул", 30], 
              ["Солнцеворот", 1], 
              ["Щитовый сход", 0], 
              ["Элесиас", 30], 
              ["Элейнт", 30], 
              ["Праздник урожая", 1], 
              ["Марпенот", 30], 
              ["Укта", 30], 
              ["Пир Луны", 1], 
              ["Найтол", 30]];
    var RL = [["Января", 31], 
              ["Февраля", 28], 
              ["Марта", 31], 
              ["Апреля", 30], 
              ["Мая", 31], 
              ["Июня", 30], 
              ["Июля", 31], 
              ["Августа", 31], 
              ["Сентября", 30], 
              ["Октября", 31], 
              ["Ноября", 30], 
              ["Декабря", 31]];
    if (y%4==0) {
      FR[10][1] = 1;
      RL[1][1] = 29;
    }
    fill(FR, FR0, selectfr);
    fill(RL, RL, selectrl);
    moon();});
  input.dispatchEvent(new Event('input'));
</script></body></html>
